# lysir_bot Telegram 机器人使用教程

## 📖 简介

这是一个账密泄露查询 Telegram 机器人，可以帮你快速查询指定域名的账密泄露情况，并支持 CSV 文件导出功能。

## 🚀 功能特性

- ✅ 查询域名泄露情况（员工、第三方、客户）
- ✅ 显示密码强度统计
- ✅ 自动处理域名格式（支持 http://、https://、www. 等）
- ✅ 用户友好的消息格式
- ✅ 完整的错误处理

## 🔧 配置说明

### 1. Telegram Bot Token

在 `tgtest_simple.py` 文件中配置你的 Telegram Bot Token：

```python
TOKEN = "你的_Telegram_Bot_Token"
```

### 2. API Key

API Key 已经配置在代码中：

```python
LEAK_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

如果需要更换 API Key，请修改代码中的 `LEAK_API_KEY` 变量。

## 📱 使用方法

### 启动机器人

```bash
python tgtest_simple.py
```

### 在 Telegram 中使用

#### 1. 开始对话

发送 `/start` 命令启动机器人：

```
/start
```

机器人会回复欢迎消息和使用说明。

#### 2. 查询域名泄露报告（默认功能）

直接发送域名给机器人即可查询，支持多种格式：

**基本格式：**
```
example.com
```

**带 www 前缀：**
```
www.example.com
```

**完整 URL：**
```
https://www.example.com
http://example.com
```

**示例：**
```
google.com
microsoft.com
github.com
```

#### 3. 查询详细泄露列表

##### 3.1 查询员工泄露列表

```
/employees example.com
```

##### 3.2 查询客户泄露列表

```
/customers example.com
```

##### 3.3 查询第三方泄露列表

```
/thirdparties example.com
```

或

```
/third_parties example.com
```

#### 4. 查询邮箱/用户名泄露

```
/email user@example.com
```

或

```
/email username123
```

#### 5. 查询子域名列表

```
/subdomains example.com
```

#### 6. 查询相关 URL 列表

```
/urls example.com
```

#### 7. CSV 导出功能（重要功能）

##### 7.1 导出员工泄露 CSV

```
/export employees example.com
```

##### 7.2 导出客户泄露 CSV

```
/export customers example.com
```

##### 7.3 导出第三方泄露 CSV

```
/export thirdparties example.com
```

##### 7.4 导出全部泄露 CSV（推荐）

一次性导出员工、客户和第三方的所有泄露数据：

```
/export all example.com
```

**功能说明：**
- 自动创建三个导出任务（员工、客户、第三方）
- 等待所有任务完成
- 自动下载并发送所有 CSV 文件
- 如果某个任务失败，会单独报告

##### 7.5 导出邮箱泄露 CSV

```
/export email user@example.com
```

##### 7.5 查看所有导出任务

```
/exports
```

**导出说明：**
- 导出任务会异步处理，需要一些时间
- 导出完成后，CSV 文件会自动通过 Telegram 发送给你
- 使用 `/export all` 可以一次性导出所有类型（员工+客户+第三方）
- 使用 `/exports` 命令查看导出任务状态
- 导出功能需要付费计划支持

### 8. 查看帮助

发送 `/help` 命令查看详细帮助信息：

```
/help
```

## 📊 查询结果说明

### 1. 域名泄露报告（默认查询）

查询结果会显示以下信息：

#### 泄露统计

- **员工泄露** (👤)：员工账户泄露数量
- **第三方泄露** (🤝)：第三方账户泄露数量
- **客户泄露** (👥)：客户账户泄露数量
- **总计**：所有泄露记录总数

#### 密码强度统计（如可用）

如果使用完整版 API（需要有效的 API Key），还会显示：

- **太弱** (too_weak)：非常弱的密码
- **弱** (weak)：弱密码
- **中等** (medium)：中等强度密码
- **强** (strong)：强密码

每个类别显示数量和百分比。

#### 示例输出

```
🔍 域名泄露查询结果: example.com
========================================

⚠️ 发现泄露记录

👤 员工泄露: 15 条
🤝 第三方泄露: 8 条
👥 客户泄露: 120 条

📊 总计: 143 条泄露记录

📈 密码强度统计:

👤 员工密码:
   • 太弱: 5 (33.3%)
   • 弱: 7 (46.7%)
   • 中等: 2 (13.3%)
   • 强: 1 (6.7%)
```

### 2. 详细泄露列表（/employees, /customers, /thirdparties）

显示具体的泄露记录，包括：

- **总数**：泄露记录总数
- **已解锁**：已解锁的记录数
- **泄露记录**：显示前10条记录，包括：
  - URL（可能被部分隐藏）
  - 用户名/邮箱
  - 密码（仅已解锁的记录显示）

#### 示例输出

```
📋 员工泄露列表
域名: example.com
========================================

📊 统计信息:
• 总数: 15 条
• 已解锁: 5 条
• 当前页: 1
• 每页: 10 条

📝 泄露记录（显示前 10 条）:

1. 🔓 user1@example.com (邮箱)
   URL: https://example.com/login
   密码: password123

2. 🔒 user2@example.com (邮箱)
   URL: https://example.com/login
```

### 3. 邮箱/用户名查询（/email）

查询指定邮箱或用户名的泄露情况。

#### 示例输出

```
📧 邮箱/用户名查询结果: user@example.com
========================================

📊 统计信息:
• 总数: 3 条
• 已解锁: 1 条

📝 泄露记录（显示前 10 条）:

1. 🔓 https://example.com/login
   密码: password123
```

### 4. 子域名查询（/subdomains）

显示域名的所有子域名及其出现次数。

#### 示例输出

```
🌐 子域名查询结果: example.com
========================================

📊 统计信息:
• 子域名总数: 25 个

📝 子域名列表（显示前 20 个）:
1. www.example.com (出现 150 次)
2. mail.example.com (出现 45 次)
3. api.example.com (出现 30 次)
```

### 5. URL 查询（/urls）

显示与域名相关的所有 URL 及其出现次数。

#### 示例输出

```
🔗 URL 查询结果: example.com
========================================

📊 统计信息:
• URL 总数: 50 个

📝 URL 列表（显示前 20 个）:
1. https://example.com/login (出现 200 次)
2. https://example.com/register (出现 150 次)
```

### 6. CSV 导出功能（/export）

创建导出任务，将泄露数据导出为 CSV 文件。

#### 导出员工泄露

```
/export employees example.com
```

#### 导出客户泄露

```
/export customers example.com
```

#### 导出第三方泄露

```
/export thirdparties example.com
```

#### 导出邮箱泄露

```
/export email user@example.com
```

#### 查看导出任务列表

```
/exports
```

#### 示例输出

**创建导出任务：**
```
✅ 导出任务已创建

📋 任务 ID: 12345
📊 状态: PENDING
💬 消息: Export task created successfully

⏳ 正在等待导出完成...
```

**导出完成后：**
机器人会自动下载 CSV 文件并通过 Telegram 发送给你：
```
✅ CSV 文件已发送
```

**查看导出列表：**
```
📋 导出任务列表（共 5 个）
========================================

1. ✅ export_example_com_employees_20240101.csv
   ID: 12345
   状态: COMPLETED
   完成时间: 2024-01-01T12:00:00Z

2. ⏳ export_example_com_customers_20240101.csv
   ID: 12346
   状态: IN_PROGRESS

3. 🔄 export_user_example_com_20240101.csv
   ID: 12347
   状态: PENDING
```

**注意事项：**
- 导出任务异步处理，可能需要几分钟到几小时
- 导出完成后，CSV 文件会自动通过 Telegram 发送给你
- 导出功能需要付费计划支持
- 每个账户最多同时有 5 个进行中的导出任务
- 如果自动下载失败，可以使用 `/exports` 查看任务状态

## ⚙️ API 信息

### API 信息

- **API 地址**：`https://api.leakradar.io`
- **认证方式**：Bearer Token
- **速率限制**：30 请求/秒

### 使用的 API 端点

1. **域名泄露报告**
   - `GET /search/domain/{domain}` - 获取域名泄露统计

2. **详细泄露列表**
   - `GET /search/domain/{domain}/employees` - 员工泄露列表
   - `GET /search/domain/{domain}/customers` - 客户泄露列表
   - `GET /search/domain/{domain}/third_parties` - 第三方泄露列表

3. **邮箱/用户名查询**
   - `POST /search/email` - 查询邮箱或用户名泄露

4. **子域名查询**
   - `GET /search/domain/{domain}/subdomains` - 查询子域名列表

5. **URL 查询**
   - `GET /search/domain/{domain}/urls` - 查询相关 URL 列表

6. **CSV 导出功能**
   - `POST /search/domain/{domain}/{leak_type}/export` - 导出域名泄露 CSV
   - `POST /search/email/export` - 导出邮箱泄露 CSV
   - `GET /exports` - 获取导出任务列表

### API 文档

- API 文档：https://api.leakradar.io

## 🛠️ 技术细节

### 使用的 Python 库

- `requests`：HTTP 请求
- `json`：JSON 数据处理
- `re`：正则表达式（域名验证）
- `time`：时间处理

### 代码结构

#### 核心功能函数

- `get_updates()`：获取 Telegram 更新
- `send_message()`：发送消息到 Telegram
- `is_valid_domain()`：验证域名格式
- `normalize_domain()`：规范化域名格式

#### API 查询函数

- `query_leak_api()`：查询域名泄露报告
- `query_domain_leaks()`：查询详细泄露列表（员工/客户/第三方）
- `query_email_leaks()`：查询邮箱/用户名泄露
- `query_domain_subdomains()`：查询子域名列表
- `query_domain_urls()`：查询 URL 列表

#### 导出功能函数

- `create_domain_export()`：创建域名泄露导出任务
- `create_email_export()`：创建邮箱泄露导出任务
- `get_exports_list()`：获取导出任务列表
- `get_export_status()`：获取导出任务状态
- `wait_for_export_completion()`：等待导出任务完成

#### 格式化函数

- `format_api_result()`：格式化域名泄露报告
- `format_leaks_list()`：格式化泄露列表
- `format_email_result()`：格式化邮箱查询结果
- `format_subdomains_result()`：格式化子域名查询结果
- `format_urls_result()`：格式化 URL 查询结果

#### 消息处理

- `handle_message()`：处理用户消息和命令

## ❓ 常见问题

### Q: 查询失败怎么办？

A: 可能的原因：
1. 域名格式不正确
2. API Key 无效或过期
3. 网络连接问题
4. API 服务暂时不可用
5. 需要付费计划才能使用某些功能

检查错误消息获取具体信息。

### Q: 为什么没有显示密码统计？

A: 密码统计需要：
1. 有效的 API Key
2. 付费计划
3. 使用完整版 API（light=false）

### Q: 为什么泄露列表中的密码显示为 "🔒"？

A: 这表示该记录尚未解锁。需要：
1. 付费计划
2. 足够的积分（points）
3. 使用解锁功能（需要额外 API 调用）

### Q: 支持查询哪些域名？

A: 支持所有有效的域名格式，包括：
- 顶级域名（.com, .org, .net 等）
- 子域名
- 国际化域名

### Q: 查询速度如何？

A: 
- API 响应时间通常在 1-3 秒
- API 速率限制：30 请求/秒
- 如果查询失败，机器人会自动重试

### Q: 可以查询多少个结果？

A: 
- 默认查询显示前 10-20 条记录
- 详细泄露列表最多显示 100 条（受 API 限制）
- 子域名和 URL 列表最多显示 100 条

### Q: 如何查询更多结果？

A: 当前版本显示第一页结果。如需更多结果，可以：
1. 使用 `/export` 命令导出完整 CSV 文件
2. 使用 API 直接调用（需要修改代码）

### Q: 如何获取 CSV 文件？

A: CSV 导出功能使用步骤：
1. 使用 `/export` 命令创建导出任务
2. 机器人会自动等待导出完成
3. 导出完成后，CSV 文件会自动通过 Telegram 发送给你
4. 如果自动下载失败，可以使用 `/exports` 命令查看任务状态

### Q: 导出任务需要多长时间？

A: 导出时间取决于数据量：
- 小量数据（<1000 条）：通常几分钟内完成
- 中等数据（1000-10000 条）：可能需要 10-30 分钟
- 大量数据（>10000 条）：可能需要几小时
- 机器人会自动等待并下载文件，完成后发送给你

### Q: 可以同时创建多少个导出任务？

A: 根据 API 限制：
- 每个账户最多同时有 5 个状态为 PENDING 或 IN_PROGRESS 的导出任务
- 如果达到限制，需要等待现有任务完成后再创建新任务

### Q: CSV 文件会自动发送吗？

A: 是的！导出任务完成后，机器人会：
1. 自动等待导出完成（最多等待 10 分钟）
2. 自动下载 CSV 文件
3. 通过 Telegram 直接发送给你
4. 发送完成后自动删除临时文件

如果自动下载失败，会提示你使用 `/exports` 查看任务详情。

## 📝 注意事项

1. **API Key 安全**：不要将 API Key 分享给他人或提交到公开仓库
2. **速率限制**：遵守 API 速率限制（30 请求/秒）
3. **数据隐私**：查询结果仅显示统计信息，不包含具体的账户密码
4. **费用**：使用 API 可能需要付费计划

## 🔗 相关链接

- API 文档：https://api.leakradar.io
- Telegram Bot API 文档：https://core.telegram.org/bots/api

---

**最后更新**：2024年

